{"version":3,"sources":["../src/datasource.js"],"names":["_","Util","CmsSigner","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","basePath","url","name","jsonData","q","util","headers","cmsVersion","ecsVersion","ecsBasePath","rdsVersion","rdsBasePath","options","requests","result","targets","forEach","target","project","metric","ycol","xcol","describe","exists","resolve","period","group","dimensions","dimensions_variables","dimension","push","ycol_variables","y_col","indexOf","length","dimensionAcsJson","dimensionAcsObj","groupId","toString","replace","JSON","stringify","i","includes","dimension_i","substring","queryConcat","parseInt","range","from","_d","getTime","to","request","doNextToken","then","response","dataDatapoints","resResult","target_datapoints","instanceId","arr","map","ycolTarget","datapoints","Datapoint","datapoint","concat","parse","Promise","all","p","catch","e","data","ms","setTimeout","cursor","count","path","isEmpty","param","method","query","buildRealUrl","d","defer","promise","wait","datasourceRequest","status","Code","angular","fromJson","Datapoints","nextToken","Cursor","ErrorCode","Success","message","title","namespacesQuery","match","filter","templateToStr","getProject","namespaces","namespace","text","metricsQuery","getMetrics","metrics","tagFilterQuery","regionId","tagType","tagKey","tagKeyFilter","tagKeyArry","split","tagKeyInd","tagsFilter","toUpperCase","tagsList","arrayToMap","dimensionsQuery","instanceId_array","strToArray","filter_array","getDimensions","is_instanceId_bool","is_filter_bool","instanceId_result","tagQuery","resourceId","resourceId_array","tag","tag_array","listTagResources","Resources","Resource","resource","Project","acs_param","UserId","error","console","log","Metric","Periods","statistics","Statistics","groupInfo","GroupId","groupName","GroupName","value","endTime","Date","startTime","response_meta","data_meta","Dimensions","datapointInfo","index","reqUrl","realUrl","buildECSRealUrl","tags","Tags","Tag","TagKey","TagValue","buildRDSRealUrl","Items","TagInfos","resourceType","v","tag_key_array","tag_value_array","t","t_split","key","tagList","rep","distinct_result","tagResource","TagResources","TagResource","ResourceId","NextToken","nextList","signer","accessKeyId","cmsAccessKey","secretAccessKey","cmsSecretKey","version","addAuthorization","obj","re","RegExp","test"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport { Util } from \"./util.js\";\nimport { CmsSigner } from \"./signer.js\";\n\nexport class GenericDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.basePath = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.jsonData = instanceSettings.jsonData;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.util = new Util(templateSrv);\n    this.headers = { \"Content-Type\": \"application/json\" };\n    this.cmsVersion = \"2018-03-08\";\n    this.ecsVersion = \"2014-05-26\";\n    this.ecsBasePath = \"https://ecs.aliyuncs.com\";\n    this.rdsVersion = \"2014-08-15\";\n    this.rdsBasePath = \"https://rds.aliyuncs.com\";\n  }\n\n  query(options) {\n    var requests = [];\n    var result = [];\n    options.targets.forEach((target) => {\n      //非空参数判空处理\n      if (!target.project || !target.metric || !target.ycol || !target.xcol) {\n        return;\n      }\n      //默认数据\n      var ycol = target.ycol;\n      var xcol = target.xcol;\n      var describe = !target.describe ? target.describe : target.describe + \".\";\n      //处理模版\n      var project = this.util.exists(target.project) ? this.util.resolve(target.project, {}) : target.project;\n      var metric = this.util.exists(target.metric) ? this.util.resolve(target.metric, {}) : target.metric;\n      var period = this.util.exists(target.period) ? this.util.resolve(target.period, {}) : target.period;\n      var group = this.util.exists(target.group) ? this.util.resolve(target.group, {}) : target.group;\n      //处理数组模版\n      var dimensions = \"\";\n\n      var dimensions_variables = [];\n\n      target.dimensions.forEach((dimension) => {\n        this.util.exists(dimension) ? dimensions_variables.push(this.util.resolve(dimension, {})) : dimensions_variables.push(dimension);\n      });\n      var ycol_variables = [];\n      ycol.forEach((y_col) => {\n        y_col.indexOf(\"$\") != -1 ? ycol_variables.push(this.util.resolve(y_col, {})) : ycol_variables.push(y_col);\n      });\n      ycol = ycol_variables.length > 0 ? ycol_variables : ycol;\n\n      //自定义监控(acs_custom)、日志监控(acs_logMonitor)处理,只取下标为0的数据\n      if (project.indexOf(\"acs_custom\") != -1 || project.indexOf(\"acs_logMonitor\") != -1) {\n        var dimensionAcsJson = target.dimensions[0];\n        var dimensionAcsObj = {\n          groupId: group.toString(),\n          dimension: dimensionAcsJson.replace(/\\&/gi, \"%26\").replace(/\\{/gi, \"%7B\").replace(/\\}/gi, \"%7D\"),\n        };\n        dimensions = JSON.stringify(dimensionAcsObj);\n      } else {\n        //正常数据\n        dimensions = \"\";\n        dimensions_variables.forEach((dimension, i) => {\n          if (typeof dimension == \"string\") {\n            dimension = dimension.includes(\"{\") ? dimension : \"{\" + dimension;\n            dimension = dimension.includes(\"}\") ? dimension : dimension + \"}\";\n            dimension = dimension.includes(\"\\\\\") ? dimension.replace(\"\\\\\", \"\\\\\\\\\") : dimension;\n            \n            dimensions += dimension + \",\";\n          } else {\n            dimension.forEach((dimension_i) => {\n              dimension_i = dimension_i.includes(\"{\") ? dimension_i : \"{\" + dimension_i;\n              dimension_i = dimension_i.includes(\"}\") ? dimension_i : dimension_i + \"}\";\n              dimension = dimension.includes(\"\\\\\") ? dimension.replace(\"\\\\\", \"\\\\\\\\\") : dimension;\n\n              dimensions += dimension_i + \",\";\n            });\n          }\n        });\n        dimensions = dimensions.substring(0, dimensions.length - 1);\n        dimensions = \"[\" + dimensions + \"]\";\n        dimensions = dimensions.replace(/\\&/gi, \"%26\").replace(/\\{/gi, \"%7B\").replace(/\\}/gi, \"%7D\");\n      }\n      //拼接url参数\n      var queryConcat = \"/?Action=QueryMetricList&Length=1000&Project=\" + project + \"&Metric=\" + metric + \"&Period=\" + period\n         + \"&Dimensions=\" + dimensions + \"&StartTime=\" + parseInt(options.range.from._d.getTime()) + \"&EndTime=\" + parseInt(options.range.to._d.getTime());\n\n      //定义Promise元数据、根据URL发起请求\n      var request = this.doNextToken(queryConcat, \"\", 0).then((response) => {\n        var dataDatapoints = response;\n        var resResult = [];\n        //处理数据分类\n        var target_datapoints = [];\n        if (dimensions.includes(\"instanceId\")) {\n          for (var i in dataDatapoints) {\n            if (!target_datapoints[dataDatapoints[i].instanceId]) {\n              var arr = [];\n              arr.push(dataDatapoints[i]);\n              target_datapoints[dataDatapoints[i].instanceId] = arr;\n            } else {\n              target_datapoints[dataDatapoints[i].instanceId].push(\n                dataDatapoints[i]\n              );\n            }\n          }\n        }\n        // 处理Grafana所需的target值、Target组的所需返回结果集\n        ycol.map((ycolTarget) => {\n          if (dimensions.includes(\"instanceId\")) {\n            for (var i in target_datapoints) {\n              var datapoints = [];\n              target_datapoints[i].forEach((Datapoint) => {\n                var datapoint = [];\n                datapoint.push(Datapoint[ycolTarget], Datapoint[xcol]);\n                // 封装返回目标的第二层数组值\n                datapoints.push(datapoint);\n              });\n              // 封装返回目标的第三层数组值\n              resResult.push({\n                target: describe + i + \".\" + ycolTarget,\n                datapoints: datapoints,\n              });\n            }\n          } else {\n            var datapoints = [];\n            dataDatapoints.forEach((Datapoint) => {\n              var datapoint = [];\n              datapoint.push(Datapoint[ycolTarget], Datapoint[xcol]);\n              // 封装返回目标的第二层数组值\n              datapoints.push(datapoint);\n            });\n            // 封装返回目标的第三层数组值\n            resResult.push({\n              target: describe + ycolTarget,\n              datapoints: datapoints,\n            });\n          }\n        });\n        // 转对象封装\n        result = result.concat(\n          typeof resResult == \"string\" ? JSON.parse(resResult) : resResult\n        );\n      });\n      requests.push(request);\n    });\n    // 统一单独处理返回值\n    return Promise.all(requests.map((p) => p.catch((e) => e))).then(() => {\n      return { data: result };\n    });\n  }\n  wait(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms))\n  }\n\n  async doNextToken(queryConcat, cursor, count) {\n    var path = \"\";\n    if (this.isEmpty(cursor)) {\n      path = queryConcat;\n    } else {\n      path = queryConcat + \"&Cursor=\" + cursor;\n    }\n    var param = {\n      path: path,\n      method: \"GET\",\n    };\n    // 签名已拼接的待查询URL\n    var query = this.buildRealUrl(param);\n    if (_.isEmpty(query)) {\n      var d = this.q.defer();\n      d.resolve({ data: [] });\n      return d.promise;\n    }\n    await this.wait(1000);\n    //定义Promise元数据、根据URL发起请求\n    return this.backendSrv\n      .datasourceRequest({\n        url: query,\n        method: \"GET\",\n        headers: this.headers,\n      })\n      .then((response) => {\n        var result = [];\n        if (response.status == \"200\" && response.data.Code == \"200\") {\n          result = angular.fromJson(response.data.Datapoints);\n          if(count > 20){\n            return result;\n          }\n          count++;\n          var nextToken = response.data.Cursor;\n          if (this.isEmpty(response.data.Cursor)) {\n            return result;\n          } else {\n            return this.doNextToken(queryConcat, nextToken, count).then((data) => {\n              return result.concat(data); \n            });\n          }\n        }\n        return result;\n      }).catch(() => {\n        return [];\n      });\n  }\n\n  // 测试连接数据源接口\n  testDatasource() {\n    var param = {\n      path: \"/?Action=AccessKeyGet\",\n      method: \"GET\",\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      }).then((response) => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          return {\n            status: \"success\",\n            message: \"Data source is working\",\n            title: \"Success\",\n          };\n        }\n      });\n  }\n\n  annotationQuery(options) {}\n\n  metricFindQuery(options) {\n    var result = [];\n    //接受一个参数\n    var namespacesQuery = options.match(/^namespaces\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/);\n    namespacesQuery =\n      namespacesQuery == null ? options.match(/^namespace\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/) : namespacesQuery;\n    if (namespacesQuery != null) {\n      var filter = this.util.templateToStr(namespacesQuery[1]);\n      return this.getProject().then((namespaces) => {\n        result = namespaces;\n        if (!this.isEmpty(filter)) {\n          result = [];\n          namespaces.map((namespace) => {\n            if (namespace.text.includes(filter)) {\n              result.push(namespace);\n            }\n          });\n        }\n        return result;\n      });\n    }\n\n    //接受二个参数\n    var metricsQuery = options.match(/^metrics\\(([^,]+?),\\s?([^,]+?)\\)/);\n    metricsQuery =\n      metricsQuery == null ? options.match(/^metric\\(([^,]+?),\\s?([^,]+?)\\)/) : metricsQuery;\n    if (metricsQuery != null) {\n      var namespace = this.util.templateToStr(metricsQuery[1]);\n      var filter = this.util.templateToStr(metricsQuery[2]);\n\n      result = [];\n      return this.getMetrics(namespace).then((metrics) => {\n        result = metrics;\n        if (!this.isEmpty(filter)) {\n          result = [];\n          metrics.map((metric) => {\n            if (metric.text.includes(filter)) {\n              result.push(metric);\n            }\n          });\n        }\n        return result;\n      });\n    }\n\n    //接受四个参数，过滤Tag提供key、value选择\n    var tagFilterQuery = options.match(/^tagFilter\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n    tagFilterQuery =\n      tagFilterQuery == null ? options.match(/^tagsFilter\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : tagFilterQuery;\n    if (tagFilterQuery != null) {\n      var type = this.util.templateToStr(tagFilterQuery[1]);\n      var regionId = this.util.templateToStr(tagFilterQuery[2]);\n      var tagType = this.isEmpty(tagFilterQuery[3]) ? \"\" : tagFilterQuery[3];\n      var tagKey = this.isEmpty(tagFilterQuery[4]) ? \"\" : tagFilterQuery[4];\n      var path = \"/?Action=DescribeTags&PageNumber=1&PageSize=100&RegionId=\" + regionId;\n      var tagKeyFilter = [];\n      if(tagKey){\n        path = \"/?Action=DescribeTags&PageNumber=1&PageSize=100&RegionId=\" + regionId + \"&Tag.1.key=\" + tagKey;\n        if(tagKey.indexOf(\"&Tag.2.key=\") != -1){\n          var tagKeyArry = tagKey.split(\"&\");\n          tagKeyArry.forEach(tagKeyInd => {\n            tagKeyFilter.push(tagKeyInd.substring(tagKeyInd.indexOf(\"key=\") == -1 ? 0 : tagKeyInd.indexOf(\"key=\") + 4));\n          })\n        }else{\n          tagKeyFilter.push(tagKey);\n        }\n\n        if(tagKey.indexOf(\"Tag.1.key=\") != -1){\n          path = \"/?Action=DescribeTags&PageNumber=1&PageSize=100&RegionId=\" + regionId + \"&\" + tagKey;\n        }\n        if(tagKey.indexOf(\"PageNumber=\") != -1){\n          path = \"/?Action=DescribeTags&PageSize=100&RegionId=\" + regionId + \"&\" + tagKey;\n        }\n        if(tagKey.indexOf(\"&\") == 0){\n          path = \"/?Action=DescribeTags&PageSize=100&RegionId=\" + regionId + tagKey;\n        }\n      }\n      var nextToken = \"\";\n      result = [];\n      return this.tagsFilter(type.toUpperCase(), nextToken, path, tagType, tagKeyFilter).then((tagsList) => {\n        return this.util.arrayToMap(tagsList);\n      });\n    }\n\n    //接受四个参数,暂不支持数组，提供dimensions选择\n    var dimensionsQuery = options.match(/^dimension\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n    dimensionsQuery =\n      dimensionsQuery == null ? options.match(/^dimensions\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : dimensionsQuery;\n    if (dimensionsQuery != null) {\n      var namespace = this.util.templateToStr(dimensionsQuery[1]);\n      var metric = this.util.templateToStr(dimensionsQuery[2]);\n\n      var instanceId = dimensionsQuery[3];\n      var instanceId_array = this.util.exists(instanceId) ? this.util.resolve(instanceId, {}) : [];\n      if (instanceId_array.length == 0) {\n        if (this.isEmpty(instanceId)) {\n          instanceId_array = [];\n        } else {\n          instanceId_array = this.util.strToArray(instanceId);\n        }\n      }\n      var filter = dimensionsQuery[4];\n      var filter_array = this.util.exists(filter) ? this.util.resolve(filter, {}) : [];\n      if (filter_array.length == 0) {\n        if (this.isEmpty(filter)) {\n          filter_array = [];\n        } else {\n          filter_array = this.util.strToArray(filter);\n        }\n      }\n      result = [];\n      return this.getDimensions(namespace, metric, \"\", []).then(\n        (dimensions) => {\n          var is_instanceId_bool = this.isEmpty(instanceId);\n          var is_filter_bool = this.isEmpty(filter);\n          if (is_instanceId_bool) {\n            result = dimensions;\n          } else {\n            var instanceId_result = [];\n            dimensions.map((dimension) => {\n              instanceId_array.forEach((i) => {\n                if (dimension.text.includes(i)) {\n                  instanceId_result.push(dimension);\n                }\n              });\n            });\n            if (is_filter_bool) {\n              result = instanceId_result;\n            } else {\n              instanceId_result.map((dimension) => {\n                filter_array.forEach((i) => {\n                  if (dimension.text.includes(i)) {\n                    result.push(dimension);\n                  }\n                });\n              });\n            }\n          }\n          return result;\n        }\n      );\n    }\n\n    //接受5个参数,暂不支持数组，提供tag选择\n    var tagQuery = options.match(/^tag\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n    tagQuery =\n      tagQuery == null ? options.match(/^tags\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : tagQuery;\n    if (tagQuery != null) {\n      var resourceId = tagQuery[4];\n      var resourceId_array = this.util.exists(resourceId) ? this.util.resolve(resourceId, {}) : [];\n      if (resourceId_array.length == 0) {\n        if (this.isEmpty(resourceId)) {\n          resourceId_array = [];\n        } else {\n          resourceId_array = [];\n          resourceId_array = this.util.strToArray(resourceId);\n        }\n      }\n      var tag = tagQuery[5];\n      var tag_array = this.util.exists(tag) ? this.util.resolve(tag, {}) : [];\n      if (tag_array.length == 0) {\n        if (this.isEmpty(tag)) {\n          tag_array = [];\n        } else {\n          tag_array = [];\n          tag_array = this.util.strToArray(tag);\n        }\n      }\n      return this.listTagResources(\n        tagQuery[1].toUpperCase(),\n        tagQuery[2],\n        tagQuery[3],\n        resourceId_array,\n        tag_array\n      );\n    }\n    return [];\n  }\n\n  //返回所有的Project,QueryProjectMeta的API无自定义监控project、日志监控project，已拼接\n  getProject() {\n    var param = {\n      path: \"/?Action=QueryProjectMeta&PageNumber=1&PageSize=1000\",\n      method: \"GET\",\n    };\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      })\n      .then((response) => {\n        var result = [];\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          data.Resources.Resource.map((resource) => {\n            if (!this.isEmpty(resource.Project)) {\n              result.push(resource.Project);\n            }\n          });\n        }\n        //增加自定义监控、日志监控选项\n        var acs_param = {\n          path: \"/?Action=AccessKeyGet\",\n          method: \"GET\",\n        };\n        return this.backendSrv\n          .datasourceRequest({\n            url: this.buildRealUrl(acs_param),\n            method: \"GET\",\n          })\n          .then((response) => {\n            var data = response.data;\n            if (data.ErrorCode == 200 && data.Success == true) {\n              result.push(\"acs_logMonitor_\" + data.UserId);\n              result.push(\"acs_customMetric_\" + data.UserId);\n            }\n            return this.util.arrayToMap(result);\n          });\n      })\n      .catch(function (error) {\n        console.log(error);\n        return;\n      });\n  }\n\n  //根据Project返回对应的所有的Metrics,无自定义监控、日志监控project对应的Metrics\n  getMetrics(project) {\n    var param = {\n      path:\n        \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1000&Project=\" +\n        project,\n      method: \"GET\",\n    };\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      })\n      .then((response) => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var result = [];\n          data.Resources.Resource.map((resource) => {\n            if (!this.isEmpty(resource.Metric)) {\n              result.push(resource.Metric);\n            }\n          });\n          return this.util.arrayToMap(result);\n        }\n      })\n      .catch(function (error) {\n        console.log(error);\n        return;\n      });\n  }\n\n  //根据Project及Metrics返回对应的所有的Period,无自定义监控、日志监控project对应的Period\n  getPeriod(project, metric) {\n    var param = {\n      path:\n        \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" +\n        project +\n        \"&Metric=\" +\n        metric,\n      method: \"GET\",\n    };\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      })\n      .then((response) => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var period = [];\n          var resource = data.Resources.Resource;\n          if (resource.length > 0 && !this.isEmpty(resource[0].Periods)) {\n            period = resource[0].Periods.split(\",\");\n          }\n          return this.util.arrayToMap(period);\n        }\n      })\n      .catch(function (error) {\n        console.log(error);\n        return;\n      });\n  }\n\n  //根据Project及Metrics返回对应的所有的Statistics,未去除已选项,无自定义监控、日志监控project对应的Period\n  getStatistics(project, metric) {\n    var param = {\n      path:\n        \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" +\n        project +\n        \"&Metric=\" +\n        metric,\n      method: \"GET\",\n    };\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      })\n      .then((response) => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var statistics = [];\n          var resource = data.Resources.Resource;\n          if (resource.length > 0 && !this.isEmpty(resource[0].Statistics)) {\n            statistics = resource[0].Statistics.split(\",\");\n          }\n          return this.util.arrayToMap(statistics);\n        }\n      })\n      .catch(function (error) {\n        console.log(error);\n        return;\n      });\n  }\n\n  //返回所有的Groups,自定义监控、日志使用\n  getGroups() {\n    var param = {\n      path: \"/?Action=ListMyGroups&PageNumber=1&PageSize=9000\",\n      method: \"GET\",\n    };\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      })\n      .then((response) => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var result = [];\n          var resource = data.Resources.Resource;\n          var i = resource.length;\n          while (i--) {\n            var group = resource[i];\n            var groupInfo = [];\n            var groupId = group.GroupId;\n            var groupName = group.GroupName;\n            if (this.isEmpty(groupId) || this.isEmpty(groupName)) {\n              continue;\n            }\n            groupInfo.push(groupId, groupName + \" / \" + groupId);\n            result.push(groupInfo);\n          }\n          return _.map(result, (d, i) => {\n            return { text: d[1], value: d[0] };\n          });\n        }\n      })\n      .catch(function (error) {\n        console.log(error);\n        return;\n      });\n  }\n\n  getDimensions(project, metric, period, dimensions) {\n    if (\n      project.indexOf(\"acs_customMetric\") != -1 ||\n      project.indexOf(\"acs_logMonitor\") != -1\n    ) {\n      return;\n    }\n    var result = [];\n    var endTime = new Date().getTime();\n    var startTime = endTime - 1 * 60 * 60 * 1000;\n    var param = {\n      path:\n        \"/?Action=QueryMetricLast&Page=1&Length=90000&Period=\" +\n        period +\n        \"&Project=\" +\n        project +\n        \"&Metric=\" +\n        metric +\n        \"&StartTime=\" +\n        startTime +\n        \"&EndTime=\" +\n        endTime,\n      method: \"GET\",\n    };\n    return this.backendSrv\n      .datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: \"GET\",\n      })\n      .then((response) => {\n        var data = response.data;\n        if (data.Success == false) {\n          return;\n        }\n        // 构建可选参数dimensions\n        param = {\n          path:\n            \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" +\n            project +\n            \"&Metric=\" +\n            metric,\n          method: \"GET\",\n        };\n        return this.backendSrv\n          .datasourceRequest({\n            url: this.buildRealUrl(param),\n            method: \"GET\",\n          })\n          .then((response_meta) => {\n            var data_meta = response_meta.data;\n            if (data_meta.ErrorCode == 200 && data_meta.Success == true) {\n              var resource = data_meta.Resources.Resource;\n              if (\n                resource.length == 0 ||\n                this.isEmpty(resource[0].Dimensions)\n              ) {\n                return;\n              }\n              var dimension = resource[0].Dimensions.split(\",\");\n              var datapoints = JSON.parse(data.Datapoints);\n              datapoints.map((datapoint) => {\n                var datapointInfo = '{\"';\n                dimension.forEach(function (value, index) {\n                  value = value.replace(/\"/g, \"\");\n                  if (value != \"userId\") {\n                    if (datapoint[value].indexOf(\":\\\\\") != -1) {\n                      datapointInfo += value + '\":\"' + datapoint[value] + '\\\\\"';\n                    } else {\n                      datapointInfo += value + '\":\"' + datapoint[value] + '\"';\n                    }\n                    if (index == dimension.length - 1) {\n                      datapointInfo += \"}\";\n                    } else {\n                      datapointInfo += ';\"';\n                    }\n                  }\n                });\n                //去重\n                if (result.length == 0) {\n                  if (dimensions.length == 0) {\n                    result.push(datapointInfo);\n                  } else if (\n                    dimensions.length > 0 &&\n                    !dimensions.includes(datapointInfo)\n                  ) {\n                    result.push(datapointInfo);\n                  }\n                } else if (\n                  result.length > 0 &&\n                  !result.includes(datapointInfo)\n                ) {\n                  if (dimensions.length == 0) {\n                    result.push(datapointInfo);\n                  } else if (\n                    dimensions.length > 0 &&\n                    !dimensions.includes(datapointInfo)\n                  ) {\n                    result.push(datapointInfo);\n                  }\n                }\n              });\n              return this.util.arrayToMap(result);\n            }\n          });\n      })\n      .catch(function (error) {\n        console.log(error);\n        return;\n      });\n  }\n\n  // 暂时无翻页功能,无nextToken字段返回\n  tagsFilter(type, nextToken, path, tagType, tagKeyFilter) {\n    var reqUrl = path;\n    if (!this.isEmpty(nextToken)) {\n      reqUrl += \"&NextToken=\" + nextToken;\n    }\n    var param = {\n      path: reqUrl,\n      method: \"GET\",\n    };\n    var realUrl = \"\";\n    if (\"ECS\" == type) {\n      realUrl = this.buildECSRealUrl(param);\n      return this.backendSrv.datasourceRequest({\n          url: realUrl,\n          method: \"GET\",\n        }).then((response) => {\n          var result = [];\n          var data = response.data;\n          var tags = data.Tags.Tag;\n          if (tags.length > 0) {\n            tags.forEach((tag) => {\n              if (\"key\" == tagType) {\n                if (!result.includes(tag.TagKey)) {\n                  result.push(tag.TagKey);\n                }\n              } else if (\"value\" == tagType) {\n                if (tagKeyFilter.includes(tag.TagKey) || tagKeyFilter.length == 0) {\n                  var value = tag.TagKey + \":/:\" + tag.TagValue;\n                  if (!result.includes(value)) {\n                    result.push(value);\n                  }\n                }\n              }\n            });\n          }\n          return result;\n        });\n    } else if (\"RDS\" == type) {\n      realUrl = this.buildRDSRealUrl(param);\n      return this.backendSrv\n        .datasourceRequest({\n          url: realUrl,\n          method: \"GET\",\n        })\n        .then((response) => {\n          var result = [];\n          var data = response.data;\n          var tags = data.Items.TagInfos;\n          if (tags.length > 0) {\n            tags.forEach((tag) => {\n              if (\"key\" == tagType) {\n                if (!result.includes(tag.TagKey)) {\n                  result.push(tag.TagKey);\n                }\n              } else if (\"value\" == tagType) {\n                if (tagKeyFilter.includes(tag.TagKey) || tagKeyFilter.length == 0) {\n                  var value = tag.TagKey + \":/:\" + tag.TagValue;\n                  if (!result.includes(value)) {\n                    result.push(value);\n                  }\n                }\n              }\n            });\n          }\n          return result;\n        });\n    }\n  }\n\n  listTagResources(type, regionId, resourceType, resourceId, tag) {\n    type = this.isEmpty(type) ? \"ECS\" : type;\n    regionId = this.isEmpty(regionId) ? \"cn-hangzhou\" : regionId;\n    if (\"ECS\" == type) {\n      resourceType = this.isEmpty(resourceType) ? \"instance\" : resourceType;\n    } else if (\"RDS\" == type) {\n      resourceType = this.isEmpty(resourceType) ? \"INSTANCE\" : resourceType;\n    }\n    var path = \"/?Action=ListTagResources&RegionId=\" + regionId + \"&ResourceType=\" + resourceType;\n    for (var i = 0; i < resourceId.length; i++) {\n      if (50 > i) {\n        var v = resourceId[i];\n        if (!this.isEmpty(v)) {\n          path += \"&ResourceId.\" + (parseInt(i) + 1).toString() + \"=\" + v;\n        }\n      }\n    }\n    var tag_key_array = [];\n    var tag_value_array = [];\n    tag.forEach((t) => {\n      if (!this.isEmpty(t)) {\n        if (t.indexOf(\":/:\") != -1) {\n          var t_split = t.split(\":/:\");\n          if (!tag_key_array.includes(t_split[0])) {\n            tag_key_array.push(t_split[0]);\n          }\n          if (!tag_value_array.includes(t_split[1])) {\n            tag_value_array.push(t_split[1]);\n          }\n        }\n      }\n    });\n    if (tag_key_array.length > 0) {\n      for (var i = 0; i < tag_key_array.length; i++) {\n        var key = tag_key_array[i];\n        path += \"&Tag.\" + (parseInt(i) + 1).toString() + \".Key=\" + key;\n      }\n    } else if (tag_key_array.length == 0 && tag.length > 0) {\n      for (var i = 0; i < tag.length; i++) {\n        var key = tag[i];\n        path += \"&Tag.\" + (parseInt(i) + 1).toString() + \".Key=\" + key;\n      }\n    }\n    var nextToken = \"\";\n    return this.tagList(type, nextToken, path, tag_value_array).then((rep) => {\n      var distinct_result = [];\n      rep.forEach((instanceId) => {\n        if (!distinct_result.includes(instanceId)) {\n          distinct_result.push(instanceId);\n        }\n      });\n      return this.util.arrayToMap(distinct_result);\n    });\n  }\n  // 处理nextToken问题\n  tagList(type, nextToken, path, tag_value_array) {\n    var reqUrl = path;\n    if (!this.isEmpty(nextToken)) {\n      reqUrl += \"&NextToken=\" + nextToken;\n    }\n    var param = {\n      path: reqUrl,\n      method: \"GET\",\n    };\n    var realUrl = \"\";\n    if (\"ECS\" == type) {\n      realUrl = this.buildECSRealUrl(param);\n    } else if (\"RDS\" == type) {\n      realUrl = this.buildRDSRealUrl(param);\n    }\n    return this.backendSrv.datasourceRequest({\n        url: realUrl,\n        method: \"GET\",\n      }).then((response) => {\n        var result = [];\n        var data = response.data;\n        var tagResource = data.TagResources.TagResource;\n        if (tagResource.length > 0) {\n          tagResource.forEach((resource) => {\n            if (tag_value_array.length > 0) {\n              if (tag_value_array.includes(resource.TagValue)) {\n                result.push(resource.ResourceId);\n              }\n            } else {\n              result.push(resource.ResourceId);\n            }\n          });\n        }\n        if (this.isEmpty(data.NextToken)) {\n          return result;\n        } else {\n          return this.tagList(type, data.NextToken, path, tag_value_array).then(\n            (nextList) => {\n              return result.concat(nextList);\n            }\n          );\n        }\n      });\n  }\n\n  // 根据云监控API文档处理URL签名,做封装调用接口用\n  buildRealUrl(param) {\n    var signer = new CmsSigner(\n      {\n        accessKeyId: this.jsonData.cmsAccessKey,\n        secretAccessKey: this.jsonData.cmsSecretKey,\n        version: this.cmsVersion,\n      },\n      param\n    );\n    signer.addAuthorization();\n    return this.basePath + signer.request.path;\n  }\n\n  // 根据ECS API文档处理URL签名,做封装调用接口用\n  buildECSRealUrl(param) {\n    var signer = new CmsSigner(\n      {\n        accessKeyId: this.jsonData.cmsAccessKey,\n        secretAccessKey: this.jsonData.cmsSecretKey,\n        version: this.ecsVersion,\n      },\n      param\n    );\n    signer.addAuthorization();\n    return this.ecsBasePath + signer.request.path;\n  }\n\n  // 根据RDS API文档处理URL签名,做封装调用接口用\n  buildRDSRealUrl(param) {\n    var signer = new CmsSigner(\n      {\n        accessKeyId: this.jsonData.cmsAccessKey,\n        secretAccessKey: this.jsonData.cmsSecretKey,\n        version: this.rdsVersion,\n      },\n      param\n    );\n    signer.addAuthorization();\n    return this.rdsBasePath + signer.request.path;\n  }\n\n  // 判断对象是否为空对象 true 空\n  isEmpty(obj) {\n    var re = new RegExp(\"^[ ]+$\");\n    if (\n      !obj ||\n      obj == \"null\" ||\n      obj == null ||\n      obj == \" \" ||\n      obj == \"\" ||\n      obj == '\"\"' ||\n      re.test(obj) ||\n      typeof obj == \"undefined\"\n    ) {\n      return true;\n    } // 为空\n    return false; // 不为空\n  }\n}\n"]}